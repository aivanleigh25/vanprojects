<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Movie Player</title>
  <meta name="color-scheme" content="dark light"/>
  <script src="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.js"></script>
  <style>
    :root {
      --bg: #0f1115;
      --panel: #171923;
      --panel-2: #1f2230;
      --text: #eef2ff;
      --muted: #aab2cf;
      --brand: #7c9cff;
      --accent: #51e1a7;
      --danger: #ff6b6b;
      --border: #2b3040;
    }

    :not(:root):fullscreen {
      object-fit: contain;
      background: #000 !important;
      width: 100% !important;
      height: 100% !important;
      margin: 0 !important;
      inset: 0 !important;
    }

    :fullscreen::backdrop {
      background: #000;
    }

    * { box-sizing: border-box }
    html, body { height: 100% }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background: linear-gradient(120deg, var(--bg), #0b0d12 60%);
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      position: fixed;
      inset: 0 auto 0 0;
      width: 120px;
      background: var(--panel);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 14px;
      padding: 20px 10px;
      transition: transform 0.3s ease;
    }

    .sidebar.hidden {
      transform: translateX(-120px);
    }

    .brand {
      font-weight: 800;
      letter-spacing: 0.5px;
      font-size: 14px;
      color: var(--brand);
      text-transform: uppercase;
    }

    .navlink, .navbtn {
      color: var(--muted);
      background: var(--panel); /* Ensure dark background */
      text-decoration: none;
      font-weight: 600;
      font-size: 13px;
      padding: 8px 10px;
      border-radius: 10px;
      transition: all 0.2s ease;
      display: block;
      text-align: center;
      border: 1px solid var(--border); /* Optional border for definition */
    }

    .navlink:hover, .navbtn:hover {
      color: var(--text);
      background: var(--panel-2);
      transform: translateY(-2px);
    }

    .main {
      margin-left: 140px;
      flex: 1;
      display: flex;
      flex-direction: column;
      transition: margin-left 0.3s ease;
    }

    .header {
      padding: 22px 20px;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
    }

    .header h1 {
      margin: 0;
      font-size: 24px;
    }

    .header p {
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 13px;
    }

    .wrap {
      max-width: 1000px;
      width: 100%;
      margin: 22px auto;
      padding: 0 16px;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 12px;
      animation: fadeIn 0.3s ease-in-out;
    }

    .input {
      flex: 1;
      min-width: 260px;
      background: var(--panel-2);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      outline: none;
      transition: border-color 0.2s ease;
    }

    .input:focus {
      border-color: var(--brand);
    }

    .select, .btn {
      background: var(--panel-2);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
    }

    .btn:hover {
      transform: scale(1.05);
      filter: brightness(1.1);
    }

    .btn.primary {
      background: var(--brand);
      border-color: transparent;
      color: #0a1024;
    }

    .btn.blue {
      background: var(--brand);
      border-color: transparent;
      color: #0a1024;
    }

    .btn.ghost {
      background: transparent;
    }

    .player {
      margin-top: 16px;
      background: #000;
      border: 1px solid var(--border);
      border-radius: 18px;
      overflow: visible;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.45);
      animation: slideIn 0.3s ease-in-out;
      display: none; /* Hidden until movie is selected */
    }

    .player.active {
      display: block;
    }

    #playerContainer {
      visibility: visible;
      position: relative;
      left: auto;
      transition: opacity 0.3s ease;
    }

    #playerContainer.active {
      visibility: visible;
      position: relative;
    }

    .player .frame-wrap {
      position: relative;
      width: 100%;
      aspect-ratio: 16/9;
      background: #000;
      border-radius: 18px;
      overflow: hidden;
    }

    iframe {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      border: 0;
      z-index: 1;
    }

    #movieFrame {
      opacity: 0;
      transition: opacity 0.6s ease;
    }

    #movieFrame.show {
      opacity: 1;
    }

    .status {
      margin-top: 10px;
      color: var(--muted);
      font-size: 12px;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .status .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 8px var(--accent);
    }

    .footer {
      margin: 24px 0 40px;
      color: var(--muted);
      font-size: 12px;
    }

    .results {
      margin-top: 20px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 14px;
      animation: fadeIn 0.4s ease forwards;
    }

    .movie {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .movie:hover {
      transform: scale(1.05);
    }

    .movie img {
      width: 100%;
      display: block;
    }

    .movie-title {
      padding: 8px;
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
      text-align: center;
    }

    dialog {
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--text);
      border-radius: 16px;
      padding: 0;
      width: min(720px, 94vw);
      animation: slideIn 0.3s ease-in-out;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      background: var(--panel); /* Ensure dark */
    }

    .modal-title {
      font-weight: 800;
      color: var(--text);
    }

    .modal-body {
      padding: 16px;
      background: var(--panel); /* Ensure dark */
      color: var(--text);
    }

    .close-x {
      all: unset;
      cursor: pointer;
      padding: 6px 8px;
      border-radius: 10px;
      transition: background 0.2s ease;
      color: var(--muted);
    }

    .close-x:hover {
      background: var(--panel-2);
    }

    @media (max-width: 768px) {
      .sidebar {
        position: static;
        width: auto;
        height: auto;
        flex-direction: row;
        justify-content: space-between;
        transform: translateX(0);
      }
      .main {
        margin-left: 0;
      }
      .brand {
        display: inline;
      }
      .toolbar {
        flex-direction: column;
      }
      .input {
        width: 100%;
      }
    }

    .home-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      font-weight: bold;
      color: inherit;
      text-align: left;
      cursor: pointer;
      padding: 0;
      transition: color 0.2s ease;
    }

    .home-btn:hover {
      color: var(--brand);
      text-decoration: underline;
    }

    #playerContainer button {
      transition: opacity 0.2s ease;
    }

    #playerContainer button:hover {
      opacity: 0.9;
    }

    .movie-info {
      margin-top: 16px;
      padding: 16px 20px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
      color: var(--text);
      line-height: 1.6;
      animation: fadeIn 0.3s ease-in-out;
    }

    .movie-info h2 {
      font-size: 1.4rem;
      margin-bottom: 10px;
      color: var(--brand);
    }

    .toggle-btn {
      background: none;
      border: none;
      color: #ffcc00;
      font-size: 1rem;
      cursor: pointer;
      margin-bottom: 8px;
      transition: transform 0.2s ease;
    }

    .toggle-btn:hover {
      transform: scale(1.05);
      text-decoration: underline;
    }

    .info-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease, opacity 0.4s ease;
      opacity: 0;
    }

    .info-content.show {
      max-height: 500px;
      opacity: 1;
    }

    #spinner {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255, 255, 255, 0.3);
      border-top: 5px solid #00bfff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      transform: translate(-50%, -50%);
      z-index: 10;
    }

    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }

    #spinner.hidden {
      display: none;
    }

    .suggestions {
      position: absolute;
      background: var(--panel-2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 8px 0;
      max-height: 200px;
      overflow-y: auto;
      z-index: 10;
      width: 100%;
      max-width: 260px;
      display: none;
    }

    .suggestion-item {
      padding: 8px 12px;
      color: var(--text);
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .suggestion-item:hover {
      background: var(--panel);
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideIn {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    a:focus, button:focus, input:focus, select:focus {
      outline: 2px solid var(--brand);
      outline-offset: 2px;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <button id="homeBtn" class="home-btn">
      <strong>Movie<br>Player</strong>
    </button>
    <a class="navlink" href="https://www.facebook.com/aivan.abanto1/" target="_blank">Contact</a>
    <button class="navbtn" id="openHelp">Ad-block</button>
    <a class="navlink" href="https://www.imdb.com/" target="_blank">IMDb</a>
    <button class="navbtn" id="openAbout">About</button>
    <button class="navbtn" id="openHistory">History</button>
  </div>

  <dialog id="historyModal">
    <div class="modal-header">
      <div class="modal-title">Watch History</div>
      <button class="close-x" id="historyClose" aria-label="Close">✕</button>
    </div>
    <div class="modal-body">
      <ul id="historyList"></ul>
    </div>
  </dialog>

  <main class="main">
    <header class="header">
      <h1>Free Movies</h1>
      <p>Search or paste an IMDb ID (e.g., <code>tt11083552</code>), pick a server, then hit Watch.</p>
    </header>

    <section class="wrap">
      <div class="toolbar" role="group" aria-label="Controls">
        <select id="seasonSelect" class="select" style="display:none"></select>
        <select id="episodeSelect" class="select" style="display:none"></select>
        <div class="relative">
          <input id="imdbInput" class="input" placeholder="Enter IMDb link, ID, or movie name" autocomplete="off" />
          <div id="suggestions" class="suggestions"></div>
        </div>
        <button id="searchBtn" class="btn blue" type="button">🔍 Search</button>
        <select id="serverSelect" class="select" aria-label="Server">
          <option value="vidsrc">Server 1 – 2Embed</option>
          <option value="vidsrcto">Server 2 – Vidsrc.me</option>
          <option value="2embed">Server 3 – Vidsrc.to</option>
          <option value="noads">Server 4 – Test (fewer ads)</option>
        </select>
        <button id="watchBtn" class="btn primary" type="button">▶ Watch</button>
        <button id="copyBtn" class="btn" type="button" title="Copy share link">🔗 Copy Link</button>
        <button id="fullscreenBtn" class="btn" type="button" title="Fullscreen">⛶ Fullscreen</button>
      </div>

      <div id="results" class="results"></div>

      <div class="player" id="playerContainer" aria-live="polite">
        <div id="spinner"></div>
        <div class="frame-wrap">
          <iframe id="movieFrame"
            allow="fullscreen; picture-in-picture; clipboard-write; encrypted-media; autoplay"
            referrerpolicy="no-referrer"
            src=""
            allowfullscreen="true"
            webkitallowfullscreen="true"
            mozallowfullscreen="true">
          </iframe>
        </div>
        <div id="movieInfo" class="movie-info" style="display:none;">
          <h2 id="movieTitle"></h2>
          <button id="toggleInfo" class="toggle-btn">More info ▼</button>
          <div id="extraInfo" class="info-content">
            <p><strong>Release Date:</strong> <span id="releaseDate">N/A</span></p>
            <p><strong>Overview:</strong> <span id="overview">N/A</span></p>
            <p><strong>Rating:</strong> <span id="rating">N/A</span></p>
          </div>
        </div>
        <div class="status" id="status">
          <span class="dot" aria-hidden="true"></span>
          <span id="statusText">Ready. Tip: Press <kbd>Enter</kbd> or click Search to find movies.</span>
        </div>
        <div class="footer">
          <p><strong>Heads-up:</strong> Only embed content you have the rights to watch. Some third-party players show ads; see <em>Ad-block Help</em> for tips. If a server fails, try a different one.</p>
        </div>
      </div>
    </section>
  </main>

  <dialog id="helpModal">
    <div class="modal-header">
      <div class="modal-title">Watch with fewer ads using 
        <a href="https://chromewebstore.google.com/detail/ublock-origin-lite/ddkjiahejlhfcafbddmgiahcphecmpfh?hl=en" 
           target="_blank" rel="noopener noreferrer">
          uBlock Origin Lite
        </a>
      </div>
      <button class="close-x" id="helpClose" aria-label="Close">✕</button>
    </div>
    <div class="modal-body">
      <p>These steps are for Chromium-based browsers (Chrome, Edge, Brave, etc.). For Firefox, install the classic <em>uBlock Origin</em> add-on.</p>
      <ol>
        <li>Install <strong>
          <a href="https://chromewebstore.google.com/detail/ublock-origin-lite/ddkjiahejlhfcafbddmgiahcphecmpfh?hl=en" 
             target="_blank" rel="noopener noreferrer">
             uBlock Origin Lite
          </a>
        </strong> from the Chrome Web Store.</li>
        <li>Pin it and make sure blocking is <strong>On</strong> for this site.</li>
        <li>Reload. Most popups/banners should be gone.</li>
      </ol>
    </div>
  </dialog>

  <dialog id="aboutModal">
    <div class="modal-header">
      <div class="modal-title">About this page</div>
      <button class="close-x" id="aboutClose" aria-label="Close">✕</button>
    </div>
    <div class="modal-body">
      <p>Search by movie title or paste IMDb ID. Click a movie card to load instantly in the player.</p>
    </div>
  </dialog>

  <script>
    const $ = sel => document.querySelector(sel);

    const helpModal = $('#helpModal');
    const aboutModal = $('#aboutModal');
    const openHelpBtn = $('#openHelp');
    const openAboutBtn = $('#openAbout');
    const helpClose = $('#helpClose');
    const aboutClose = $('#aboutClose');

    openHelpBtn.addEventListener('click', () => helpModal.showModal());
    openAboutBtn.addEventListener('click', () => aboutModal.showModal());
    helpClose.addEventListener('click', () => helpModal.close());
    aboutClose.addEventListener('click', () => aboutModal.close());

    const input = $('#imdbInput');
    const select = $('#serverSelect');
    const frame = $('#movieFrame');
    const playerContainer = $('#playerContainer');
    const watchBtn = $('#watchBtn');
    const fullscreenBtn = document.getElementById("fullscreenBtn");

    const exitBtn = document.createElement("button");
    exitBtn.textContent = "❌ Exit Fullscreen";
    Object.assign(exitBtn.style, {
      position: "absolute",
      top: "10px",
      right: "10px",
      zIndex: "9999",
      padding: "10px 14px",
      fontSize: "14px",
      background: "#ff4d4d",
      color: "#fff",
      border: "none",
      borderRadius: "8px",
      cursor: "pointer",
      opacity: "0.6",
      display: "none",
      pointerEvents: "auto"
    });

    playerContainer.appendChild(exitBtn);

    fullscreenBtn.addEventListener("click", () => {
      if (playerContainer.requestFullscreen) playerContainer.requestFullscreen();
      else if (playerContainer.webkitRequestFullscreen) playerContainer.webkitRequestFullscreen();
      else if (playerContainer.mozRequestFullScreen) playerContainer.mozRequestFullScreen();
      else if (playerContainer.msRequestFullscreen) playerContainer.msRequestFullscreen();

      exitBtn.style.display = "block";
    });

    exitBtn.addEventListener("click", () => {
      if (document.exitFullscreen) document.exitFullscreen();
      else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
      else if (document.mozCancelFullScreen) document.mozCancelFullScreen();
      else if (document.msExitFullscreen) document.msExitFullscreen();
    });

    function onFsChange() {
      const inFs = document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement;
      exitBtn.style.display = inFs ? "block" : "none";
    }

    document.addEventListener("fullscreenchange", onFsChange);
    document.addEventListener("webkitfullscreenchange", onFsChange);
    document.addEventListener("mozfullscreenchange", onFsChange);
    document.addEventListener("MSFullscreenChange", onFsChange);

    const statusText = $('#statusText');
    const resultsDiv = $('#results');
    const suggestionsDiv = $('#suggestions');

    const API_KEY = "6452370c23b5a8497b9a201cf46fba42";
    const TMDB_SEARCH = "https://api.themoviedb.org/3/search/movie?api_key="+API_KEY+"&query=";
    const TMDB_DETAILS = id => `https://api.themoviedb.org/3/movie/${id}?api_key=${API_KEY}`;

    const extractIMDb = (str='') => {
      const m = String(str).match(/tt\d{7,8}/i);
      return m ? m[0] : '';
    };

    function buildURL(server, imdbID, season=null, episode=null) {
      if (season && episode) {
        switch(server){
          case 'vidsrcto': return `https://www.2embed.cc/embedtv/${imdbID}&s=${season}&e=${episode}`;
          case 'vidsrc': return `https://vidsrc.me/embed/tv?imdb=${imdbID}&s=${season}&e=${episode}`;
          case '2embed': return `https://vidsrc.to/embed/tv/${imdbID}/${season}/${episode}`;
          case 'noads': return `https://vid-src-embeds-no-ads-demo.vercel.app/embed?url=${encodeURIComponent(`https://vidsrc.in/embed/${imdbID}/${season}-${episode}`)}`;
        }
      } else {
        switch(server){
          case 'vidsrcto': return `https://www.2embed.cc/embed/${imdbID}`;
          case 'vidsrc': return `https://vidsrc.me/embed/movie?imdb=${imdbID}`;
          case '2embed': return `https://vidsrc.to/embed/movie/${imdbID}`;
          case 'noads': return `https://vid-src-embeds-no-ads-demo.vercel.app/embed?url=${encodeURIComponent(`https://vidsrc.in/embed/${imdbID}`)}`;
        }
      }
    }

    const setStatus = (msg) => statusText.textContent = msg;

    function loadFromFields(imdbIDOverride, season=null, episode=null) {
      const imdbID = imdbIDOverride || extractIMDb(input.value.trim());
      if (!imdbID) { alert('Please enter a valid IMDb ID.'); return; }

      if (!select.value) select.value = "2embed";

      const embedURL = buildURL(select.value, imdbID, season, episode);
      if (!embedURL) { alert('Unknown server selected.'); return; }

      playerContainer.classList.add("active");

      frame.setAttribute("allowfullscreen", "true");
      frame.setAttribute("webkitallowfullscreen", "true");
      frame.setAttribute("mozallowfullscreen", "true");

      const spinner = document.getElementById("spinner");
      spinner.classList.remove("hidden");
      frame.classList.remove("show");

      frame.onload = () => {
        frame.classList.add("show");
        spinner.classList.add("hidden");
      };

      frame.src = embedURL;
      showInfoByIMDb(imdbID);

      fetchTitleFromTMDB(imdbID).then(title => {
        if (season && episode) {
          setStatus(`Now Playing: ${title} — Season ${season}, Episode ${episode}`);
          document.querySelector(".header h1").textContent = `Now Watching: ${title} — S${season}E${episode}`;
        } else {
          setStatus(`Now Playing: ${title}`);
          document.querySelector(".header h1").textContent = `Now Watching: ${title}`;
        }
        if (title && !title.toLowerCase().includes("free")) {
          saveHistory(imdbID, title, season, episode);
        }
      });
    }

    async function loadSeasons(showData, imdbID) {
      const seasonSelect = document.getElementById("seasonSelect");
      const episodeSelect = document.getElementById("episodeSelect");
      seasonSelect.style.display = "inline-block";
      episodeSelect.style.display = "inline-block";

      seasonSelect.innerHTML = showData.seasons
        .map(s => `<option value="${s.season_number}">Season ${s.season_number}</option>`)
        .join("");

      async function loadEpisodes(seasonNum) {
        const res = await fetch(`https://api.themoviedb.org/3/tv/${showData.id}/season/${seasonNum}?api_key=${API_KEY}`);
        const data = await res.json();
        episodeSelect.innerHTML = data.episodes
          .map(e => `<option value="${e.episode_number}">Ep ${e.episode_number} — ${e.name}</option>`)
          .join("");
      }

      await loadEpisodes(seasonSelect.value);

      seasonSelect.onchange = () => {
        loadEpisodes(seasonSelect.value);
        const season = seasonSelect.value;
        const episode = episodeSelect.value;
        loadFromFields(imdbID, season, episode); // Load directly on change
      };

      episodeSelect.onchange = () => {
        const season = seasonSelect.value;
        const episode = episodeSelect.value;
        loadFromFields(imdbID, season, episode); // Load directly on change
      };

      watchBtn.style.display = "none"; // Hide Watch button for season/episode
      loadFromFields(imdbID, seasonSelect.value, episodeSelect.value); // Initial load
    }

    window.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      const imdb = params.get('imdb');
      if (imdb && window.loadFromFields) {
        document.getElementById('imdbInput').value = imdb;
        window.loadFromFields(imdb);
        showInfoByIMDb(imdb);
      }

      const homeBtn = document.getElementById("homeBtn");
      homeBtn.addEventListener("click", () => {
        const input = document.getElementById("imdbInput");
        const imdbID = input.value.trim();
        const homeURL = "https://vanprojects.netlify.app/freemovie/";
        window.location.href = homeURL;
      });

      const select = document.getElementById('serverSelect');
      const input = document.getElementById('imdbInput');
      select.addEventListener('change', () => {
        const imdbID = input.value.trim();
        if (imdbID && extractIMDb(imdbID)) {
          loadFromFields();
        }
      });
    });

    $('#watchBtn').addEventListener('click', () => loadFromFields());
    $('#searchBtn').addEventListener('click', () => {
      const query = input.value.trim();
      if (extractIMDb(query)) {
        loadFromFields();
      } else {
        searchTMDB(query);
      }
    });

    document.addEventListener('keydown', e => {
      if (e.key === 'Enter' && document.activeElement === input) {
        e.preventDefault();
        if (extractIMDb(input.value.trim())) loadFromFields();
        else searchTMDB(input.value.trim());
      }
    });

    const TMDB_SEARCH_MOVIE = "https://api.themoviedb.org/3/search/movie?api_key="+API_KEY+"&query=";
    const TMDB_SEARCH_TV = "https://api.themoviedb.org/3/search/tv?api_key="+API_KEY+"&query=";

    async function searchTMDB(query) {
      if (!query) return;
      setStatus("Searching…");
      resultsDiv.innerHTML = "";

      const [resMovie, resTV] = await Promise.all([
        fetch(TMDB_SEARCH_MOVIE + encodeURIComponent(query)),
        fetch(TMDB_SEARCH_TV + encodeURIComponent(query))
      ]);

      const movies = (await resMovie.json()).results || [];
      const shows = (await resTV.json()).results || [];

      if (!movies.length && !shows.length) {
        setStatus("No results.");
        return;
      }

      [...movies, ...shows].forEach(m => {
        if (!m.poster_path) return;
        const title = m.title || m.name;
        const div = document.createElement("div");
        div.className = "movie";
        div.innerHTML = `<img src="https://image.tmdb.org/t/p/w342${m.poster_path}"><div class="movie-title">${title}</div>`;
        div.onclick = async () => {
          const type = m.title ? "movie" : "tv";
          const detRes = await fetch(`https://api.themoviedb.org/3/${type}/${m.id}?api_key=${API_KEY}&append_to_response=external_ids`);
          const det = await detRes.json();
          const imdbID = det.external_ids?.imdb_id;
          if (imdbID) {
            input.value = imdbID;
            if (type === "tv") {
              await loadSeasons(det, imdbID);
            } else {
              loadFromFields(imdbID);
            }
            resultsDiv.innerHTML = "";
          } else {
            setStatus("No IMDb ID found.");
          }
        };
        resultsDiv.appendChild(div);
      });
      setStatus("Click a title to watch.");
    }

    async function loadTrending() {
      setStatus("Loading trending…");
      resultsDiv.innerHTML = "";

      const [resMovies, resShows] = await Promise.all([
        fetch(`https://api.themoviedb.org/3/trending/movie/week?api_key=${API_KEY}`),
        fetch(`https://api.themoviedb.org/3/trending/tv/week?api_key=${API_KEY}`)
      ]);

      const movies = (await resMovies.json()).results || [];
      const shows = (await resShows.json()).results || [];
      const items = [...movies, ...shows];

      if (!items.length) {
        setStatus("No trending results.");
        return;
      }

      items.forEach(m => {
        if (!m.poster_path) return;
        const title = m.title || m.name;
        const div = document.createElement("div");
        div.className = "movie";
        div.innerHTML = `<img src="https://image.tmdb.org/t/p/w342${m.poster_path}"><div class="movie-title">${title}</div>`;
        div.onclick = async () => {
          const type = m.title ? "movie" : "tv";
          const detRes = await fetch(`https://api.themoviedb.org/3/${type}/${m.id}?api_key=${API_KEY}&append_to_response=external_ids`);
          const det = await detRes.json();
          const imdbID = det.external_ids?.imdb_id;
          if (imdbID) {
            input.value = imdbID;
            if (type === "tv") {
              await loadSeasons(det, imdbID);
            } else {
              loadFromFields(imdbID);
            }
            resultsDiv.innerHTML = "";
            showMovieInfo(m.id, type);
          } else {
            setStatus("No IMDb ID found.");
          }
        };
        resultsDiv.appendChild(div);
      });

      setStatus("Trending this week:");
    }

    const historyModal = $('#historyModal');
    const historyClose = $('#historyClose');
    const openHistoryBtn = $('#openHistory');
    const historyList = $('#historyList');

    openHistoryBtn.addEventListener('click', () => {
      renderHistory();
      historyModal.showModal();
    });
    historyClose.addEventListener('click', () => historyModal.close());

    const TMDB_KEY = "6452370c23b5a8497b9a201cf46fba42";

    async function fetchTitleFromTMDB(imdbID) {
      try {
        const res = await fetch(`https://api.themoviedb.org/3/find/${imdbID}?api_key=${TMDB_KEY}&external_source=imdb_id`);
        const data = await res.json();
        if (data.movie_results?.length) {
          return data.movie_results[0].title;
        } else if (data.tv_results?.length) {
          return data.tv_results[0].name;
        }
        return imdbID;
      } catch (e) {
        console.error("TMDB lookup failed:", e);
        return imdbID;
      }
    }

    function saveHistory(imdbID, title, season=null, episode=null) {
      if (!imdbID || imdbID.toLowerCase().includes("free")) return;

      let history = JSON.parse(localStorage.getItem('watchHistory') || "[]");
      history = history.filter(h => h.imdbID !== imdbID || h.season !== season || h.episode !== episode);

      history.unshift({ imdbID, title, season, episode, time: Date.now() });
      if (history.length > 20) history.pop();

      localStorage.setItem('watchHistory', JSON.stringify(history));
    }

    function renderHistory() {
      let history = JSON.parse(localStorage.getItem('watchHistory') || "[]");
      historyList.innerHTML = "";
      if (!history.length) {
        historyList.innerHTML = "<li>No history yet.</li>";
        return;
      }
      history.forEach(h => {
        const li = document.createElement("li");
        const d = new Date(h.time).toLocaleString();
        li.textContent = h.season && h.episode
          ? `${h.title} — S${h.season}E${h.episode} — ${d}`
          : `${h.title} — ${d}`;
        li.style.cursor = "pointer";
        li.onclick = () => {
          input.value = h.imdbID;
          loadFromFields(h.imdbID);
          showInfoByIMDb(h.imdbID);
          historyModal.close();
        };
        historyList.appendChild(li);
      });
    }

    window.addEventListener("load", () => {
      console.log(`
██   ██ ██    ██ ██    ██ ██ 
██   ██ ██    ██  ██  ██  ██ 
███████ ██    ██   ████   ██ 
██   ██ ██    ██    ██       
██   ██  ██████     ██    ██ 
                                                        
      `);
      console.log("nag unsa ka diri dawg 🐶");
    });

    window.addEventListener('DOMContentLoaded', () => {
      if (!new URLSearchParams(window.location.search).get('imdb')) {
        loadTrending();
      }
    });

    async function showMovieInfo(tmdbID, type="movie") {
      try {
        const res = await fetch(`https://api.themoviedb.org/3/${type}/${tmdbID}?api_key=${API_KEY}&append_to_response=credits`);
        const data = await res.json();

        const title = data.title || data.name || "Unknown Title";
        const mainOverview = data.overview || "No description available.";
        const mainRating = data.vote_average ? data.vote_average.toFixed(1) : null;

        document.getElementById("movieTitle").textContent = title;
        const movieOverviewEl = document.getElementById("movieOverview");
        if (movieOverviewEl) movieOverviewEl.textContent = mainOverview;
        const movieRatingEl = document.getElementById("movieRating");
        if (movieRatingEl) movieRatingEl.textContent = mainRating ? mainRating : "N/A";

        const castList = (data.credits?.cast || []).slice(0, 5).map(c => c.name).join(", ");
        const movieCastEl = document.getElementById("movieCast");
        if (movieCastEl) movieCastEl.textContent = castList || "Unknown";

        const releaseText = data.release_date || data.first_air_date || "N/A";
        const extraOverviewEl = document.getElementById("overview");
        const releaseEl = document.getElementById("releaseDate");
        const ratingEl = document.getElementById("rating");

        if (releaseEl) releaseEl.textContent = releaseText;
        if (extraOverviewEl) extraOverviewEl.textContent = mainOverview;
        if (ratingEl) ratingEl.textContent = mainRating ? (mainRating + "/10") : "N/A";

        const movieInfoContainer = document.getElementById("movieInfo");
        if (movieInfoContainer) movieInfoContainer.style.display = "block";

        const toggleBtn = document.getElementById("toggleInfo");
        const extraInfo = document.getElementById("extraInfo");
        if (extraInfo) {
          extraInfo.classList.remove("show");
          extraInfo.classList.add("hidden");
        }
        if (toggleBtn) toggleBtn.textContent = "More info ▼";
      } catch (e) {
        console.error("Movie info fetch failed:", e);
        const movieInfoContainer = document.getElementById("movieInfo");
        if (movieInfoContainer) movieInfoContainer.style.display = "none";
      }
    }

    async function showInfoByIMDb(imdbID) {
      try {
        const res = await fetch(`https://api.themoviedb.org/3/find/${imdbID}?api_key=${API_KEY}&external_source=imdb_id`);
        const data = await res.json();

        if (data.movie_results?.length) {
          return showMovieInfo(data.movie_results[0].id, "movie");
        }
        if (data.tv_results?.length) {
          return showMovieInfo(data.tv_results[0].id, "tv");
        }

        document.getElementById("movieInfo").style.display = "none";
      } catch (e) {
        console.error("IMDb->TMDB lookup failed:", e);
      }
    }

    const toggleBtn = document.getElementById("toggleInfo");
    const extraInfo = document.getElementById("extraInfo");

    if (toggleBtn && extraInfo) {
      toggleBtn.addEventListener("click", () => {
        if (extraInfo.classList.contains("show")) {
          extraInfo.classList.remove("show");
          extraInfo.classList.add("hidden");
          toggleBtn.textContent = "More info ▼";
        } else {
          extraInfo.classList.add("show");
          extraInfo.classList.remove("hidden");
          toggleBtn.textContent = "Less info ▲";
        }
      });
    }

    // Predictive Search
    input.addEventListener('input', async () => {
      const query = input.value.trim();
      if (query.length < 1) {
        suggestionsDiv.style.display = 'none';
        return;
      }

      const res = await fetch(`${TMDB_SEARCH_MOVIE}${encodeURIComponent(query)}`);
      const data = await res.json();
      const movies = data.results || [];

      suggestionsDiv.innerHTML = '';
      if (movies.length === 0) {
        const div = document.createElement('div');
        div.className = 'suggestion-item';
        div.textContent = 'No results';
        suggestionsDiv.appendChild(div);
      } else {
        movies.slice(0, 5).forEach(movie => {
          const title = movie.title || movie.name;
          const div = document.createElement('div');
          div.className = 'suggestion-item';
          div.textContent = title;
          div.onclick = () => {
            input.value = title;
            suggestionsDiv.style.display = 'none';
            searchTMDB(title);
          };
          suggestionsDiv.appendChild(div);
        });
      }
      suggestionsDiv.style.display = 'block';
    });

    input.addEventListener('blur', () => {
      setTimeout(() => suggestionsDiv.style.display = 'none', 200);
    });

    input.addEventListener('focus', () => {
      if (input.value.trim().length >= 1) {
        suggestionsDiv.style.display = 'block';
      }
    });
  </script>
  <script src="mobile-fix.js"></script>
  <script src="copy-link.js"></script>
</body>
</html>